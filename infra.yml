- name: Setup Ubuntu Server
  hosts: linux
  gather_facts: true
  roles:
    - role: docker
      tags: docker
      vars:
        docker_arch: arm64

    - role: github_self_hosted_runner
      tags: github
      vars:
        github_self_hosted_runner_arch: arm64
        github_self_hosted_runner_version: "2.328.0"
        github_self_hosted_runner_name: "ubuntu-16gb-nbg1-1"
        github_self_hosted_runner_organization: CD-Commerce
        github_self_hosted_runner_token: ASDM7ZKWG5NJMKKJTH6X7PDIYGCWO

    - role: nginx_ssl
      tags: nginx
      vars:
        nginx_ssl_domain_email: j.dueck@cd-commerce.de
        nginx_ssl_domains:
          - auth.cd-commerce.cloud
          - product-research.cd-commerce.cloud
          - cogs.cd-commerce.cloud

    - role: jtl_db
      tags: jtl

    - role: task_scheduler
      tags: tasks
      vars:
        task_scheduler_tasks:
          - name: cogs_syncjtl
            image: cogs-syncjtl
            schedule: "*-*-* 06:00:00" #every day 6am

    - role: grafana.grafana.alloy
      tags: alloy
      vars:
        alloy_user_groups:
          - "docker" # necessary for monitoring docker => needs access to docker socket
        alloy_systemd_override: | # alloy needs to run as root to run cAdvisor
          [Service]
          User=root
        alloy_config: |
          remotecfg {
                  url            = "https://fleet-management-prod-011.grafana.net"
                  id             = "ubuntu-16gb-nbg1-1"
                  poll_frequency = "60s"

                  basic_auth {
                          username = "1117430"
                          password = sys.env("GCLOUD_RW_API_KEY") 
                  }
          }
        alloy_env_file_vars:
          GCLOUD_RW_API_KEY: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            39633930646663343766336463316534636637393731616165656662333439353935346365363031
            6232646537313332383236633165373964373237396135350a633963646534663562323536333236
            64666361303939373933633632633836303232313038303934653065326134373166366536356464
            6630336334613963370a663662623139633938383763653461666266353362643863323363363564
            36383430396462323936346232386661623033663761666535393230656632326435333237366566
            37373762616465303961613936366462303264643962346263333738323134613265633135366533
            61323132396435316335336639653432383231313934373335626535653265616438326661396638
            39383432633130613566663238306538386366336365363038333631343334613663363436663934
            35626334343236326564313331326139383534336430366438373131343538623532303766323637
            61326232303338353463313637633734363330306633393530643834323464326332613732323731
            30666132346131663466626438343733306133646364393634636530323763623134363338303039
            65373263333634306362
